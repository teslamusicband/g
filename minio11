# Аудит пользователей и политик MinIO

## 1. Просмотр всех пользователей и учетных записей

```bash
# Список всех пользователей
mc admin user list myminio

# Список всех сервисных аккаунтов (Service Accounts)
mc admin user svcacct list myminio

# Информация о текущем пользователе (под которым подключены)
mc admin info myminio --json | jq '.info.servers[0].network'

# Проверка информации о подключении
mc alias list myminio
```

## 2. Детальная информация о конкретном пользователе

```bash
# Информация о пользователе softwareUSER
mc admin user info myminio softwareUSER

# Информация о пользователе в JSON формате для детального анализа
mc admin user info myminio softwareUSER --json

# Проверка статуса пользователя (enabled/disabled)
mc admin user info myminio softwareUSER --json | jq '.status'
```

## 3. Просмотр всех политик

```bash
# Список всех политик
mc admin policy list myminio

# Детали конкретной политики
mc admin policy info myminio readwrite
mc admin policy info myminio readonly
mc admin policy info myminio writeonly
mc admin policy info myminio diagnostics
mc admin policy info myminio consoleAdmin

# Экспорт политики в файл для анализа
mc admin policy info myminio readwrite > readwrite-policy.json
mc admin policy info myminio readonly > readonly-policy.json
```

## 4. Анализ прав доступа к бакетам

```bash
# Список всех бакетов
mc ls myminio

# Проверка прав доступа к конкретному бакету
mc ls myminio/bucket-name --recursive

# Тестирование доступа под пользователем softwareUSER
# Сначала создайте алиас для этого пользователя
mc alias set testsoft https://your-minio-endpoint:9000 softwareUSER PASSWORD_HERE

# Проверка доступа к бакетам
mc ls testsoft/
```

## 5. Поиск root/admin пользователя

```bash
# Ваш текущий пользователь может быть root-пользователем
# Проверьте переменные окружения или конфигурацию
mc alias list

# Проверка групп пользователей
mc admin group list myminio

# Информация о всех группах
mc admin group info myminio --json
```

## 6. Создание скрипта для полного аудита

```bash
#!/bin/bash
# Скрипт для полного аудита MinIO

echo "=== АУДИТ MINIO КЛАСТЕРА ==="
echo "Дата: $(date)"
echo

echo "1. Информация о кластере:"
mc admin info myminio
echo

echo "2. Список всех пользователей:"
mc admin user list myminio
echo

echo "3. Список сервисных аккаунтов:"
mc admin user svcacct list myminio
echo

echo "4. Список всех политик:"
mc admin policy list myminio
echo

echo "5. Список всех бакетов:"
mc ls myminio
echo

echo "6. Детали пользователя softwareUSER:"
mc admin user info myminio softwareUSER
echo

echo "7. Детали политики readwrite:"
mc admin policy info myminio readwrite
echo

echo "8. Детали политики readonly:"
mc admin policy info myminio readonly
echo

echo "9. Список групп:"
mc admin group list myminio
echo

echo "=== КОНЕЦ АУДИТА ==="
```

## 7. Проверка прав доступа к конкретным бакетам

```bash
# Создайте тестовый файл
echo "test content" > audit-test.txt

# Для каждого бакета проверьте доступ
for bucket in $(mc ls myminio | awk '{print $5}'); do
    echo "Проверка бакета: $bucket"
    
    # Попытка загрузки (если есть права на запись)
    mc cp audit-test.txt myminio/$bucket/audit-test.txt 2>/dev/null && echo "  Запись: ✓" || echo "  Запись: ✗"
    
    # Попытка чтения (если есть права на чтение)
    mc ls myminio/$bucket/ 2>/dev/null && echo "  Чтение: ✓" || echo "  Чтение: ✗"
    
    # Удаление тестового файла
    mc rm myminio/$bucket/audit-test.txt 2>/dev/null
    echo
done

# Удаление тестового файла
rm audit-test.txt
```

## 8. Анализ JSON политик

```bash
# Экспорт всех политик для анализа
mkdir -p minio-policies
for policy in $(mc admin policy list myminio | tail -n +2); do
    echo "Экспорт политики: $policy"
    mc admin policy info myminio $policy > minio-policies/$policy.json
done

# Анализ ресурсов в политиках
echo "Анализ ресурсов в политиках:"
for file in minio-policies/*.json; do
    echo "Политика: $(basename $file .json)"
    jq -r '.Statement[].Resource[]?' "$file" 2>/dev/null | sort -u
    echo
done
```

## 9. Проверка Service Accounts

```bash
# Получить список всех service accounts
mc admin user svcacct list myminio

# Для каждого service account получить информацию
for svcacct in $(mc admin user svcacct list myminio --json | jq -r '.accessKey'); do
    echo "Service Account: $svcacct"
    mc admin user svcacct info myminio $svcacct
    echo
done
```

## 10. Дополнительные команды для диагностики

```bash
# Логи аудита (если включены)
mc admin logs myminio --type audit

# Статистика использования
mc admin prometheus metrics myminio

# Информация о конфигурации
mc admin config get myminio

# Проверка статуса сервисов
mc admin service status myminio
```

## Важные замечания:

1. **Root пользователь**: Если ваш пользователь не отображается в списке, возможно, это root-пользователь или пользователь, настроенный через переменные окружения MINIO_ROOT_USER/MINIO_ROOT_PASSWORD.

2. **Service Accounts**: MinIO может использовать service accounts, которые не отображаются в обычном списке пользователей.

3. **Политики**: 
   - `readwrite` - чтение и запись
   - `readonly` - только чтение
   - `writeonly` - только запись
   - `diagnostics` - диагностические операции
   - `consoleAdmin` - административные права через веб-консоль

4. **Тестирование**: Всегда тестируйте доступ безопасным способом, используя тестовые файлы.

5. **Безопасность**: Сохраните результаты аудита в безопасном месте для документирования состояния безопасности.















Вот команды для детального анализа пользователей и политик в вашем MinIO кластере:Основные причины, почему ваш пользователь не отображается в списке:

1. **Root пользователь** - если вы подключаетесь с учетными данными, которые были установлены как `MINIO_ROOT_USER` и `MINIO_ROOT_PASSWORD`, они не отображаются в списке обычных пользователей.

2. **Service Account** - возможно, вы используете сервисный аккаунт, который создается отдельно.

3. **Встроенные учетные данные** - пользователь может быть настроен через конфигурационные файлы, а не через команды администрирования.

Для полного понимания структуры безопасности рекомендую выполнить команды из инструкции выше в следующем порядке:

1. Сначала `mc admin info myminio` и `mc alias list` для понимания текущего подключения
2. Затем `mc admin user list` и `mc admin user svcacct list` для всех пользователей
3. После этого `mc admin policy list` и детали каждой политики
4. И наконец, тестирование доступа к бакетам

Это даст вам полную картину того, кто имеет доступ к каким ресурсам в вашем MinIO кластере.
